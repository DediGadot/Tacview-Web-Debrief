{% extends "base.html" %}

{% block title %}Mission Dashboard - DCS Debrief{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar Navigation -->
    <div class="col-xl-2 col-lg-3">
        <div class="sidebar">
            <div class="sidebar-item active" data-target="overview">
                <i class="fas fa-tachometer-alt me-2"></i>
                Mission Overview
            </div>
            <div class="sidebar-item" data-target="pilots">
                <i class="fas fa-user-pilot me-2"></i>
                Pilot Performance
            </div>
            <div class="sidebar-item" data-target="weapons">
                <i class="fas fa-crosshairs me-2"></i>
                Weapon Analysis
            </div>
            <div class="sidebar-item" data-target="groups">
                <i class="fas fa-users me-2"></i>
                Group Comparison
            </div>
            <div class="sidebar-item" data-target="timeline">
                <i class="fas fa-clock me-2"></i>
                Combat Timeline
            </div>
            <div class="sidebar-item" data-target="leaderboard">
                <i class="fas fa-trophy me-2"></i>
                Efficiency Rankings
            </div>
            <div class="sidebar-item" data-target="network">
                <i class="fas fa-project-diagram me-2"></i>
                Kill Networks
            </div>
            <div class="sidebar-item" data-target="air-to-ground">
                <i class="fas fa-bomb me-2"></i>
                Air-to-Ground Analysis
            </div>
            <div class="sidebar-item" data-target="ag-pilots">
                <i class="fas fa-crosshairs me-2"></i>
                A2G by Pilot
            </div>
            <div class="sidebar-item" data-target="ag-groups">
                <i class="fas fa-users-cog me-2"></i>
                A2G by Group
            </div>
            <div class="sidebar-item" data-target="summary">
                <i class="fas fa-file-alt me-2"></i>
                Mission Summary
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-xl-10 col-lg-9">
        <!-- Mission Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="mb-1">
                                    <i class="fas fa-fighter-jet me-2 text-primary"></i>
                                    Mission Analysis Complete
                                </h2>
                                <p class="text-muted mb-0">
                                    Session: {{ session_id }} | 
                                    Processed: {{ session_data.timestamp[:19] | replace('T', ' ') }}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group">
                                    <a href="{{ url_for('download_file', session_id=session_id, file_type='json') }}" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-download me-1"></i>JSON
                                    </a>
                                    <a href="{{ url_for('download_file', session_id=session_id, file_type='xml') }}" 
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-download me-1"></i>XML
                                    </a>
                                    <button class="btn btn-outline-info btn-sm" onclick="printReport()">
                                        <i class="fas fa-print me-1"></i>Print
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview Section -->
        <div id="overview-section" class="dashboard-section">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-tachometer-alt me-2"></i>Mission Overview</h3>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ "%.1f"|format(session_data.mission_data.mission_summary.duration / 60) }}</div>
                        <div class="stat-label">Minutes</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ session_data.mission_data.mission_summary.active_pilots }}</div>
                        <div class="stat-label">Active Pilots</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ session_data.mission_data.pilots.values() | selectattr('kills') | sum(attribute='kills') }}</div>
                        <div class="stat-label">Total Kills</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stat-card">
                        <div class="stat-number">{{ session_data.mission_data.pilots.values() | selectattr('shots_fired') | sum(attribute='shots_fired') }}</div>
                        <div class="stat-label">Shots Fired</div>
                    </div>
                </div>
            </div>
            
            <!-- Mission Overview Chart -->
            <div class="chart-container">
                <div id="missionOverviewChart"></div>
            </div>
            
            <!-- Mission Overview Legend -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Mission Overview Statistics Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="text-primary">Quick Statistics</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Minutes:</strong> Total mission duration from start to end</li>
                                        <li><strong>Active Pilots:</strong> Number of pilots who participated in combat</li>
                                        <li><strong>Total Kills:</strong> Sum of all confirmed aircraft kills</li>
                                        <li><strong>Shots Fired:</strong> Total weapons discharged during mission</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-success">Mission Duration Gauge</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Green Zone:</strong> 0-30 minutes (Short engagement)</li>
                                        <li><strong>Yellow Zone:</strong> 30-60 minutes (Standard mission)</li>
                                        <li><strong>Red Threshold:</strong> 90+ minutes (Extended operation)</li>
                                        <li><strong>Gauge Value:</strong> Actual mission time in minutes</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-warning">Combat Statistics</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Kills Bar:</strong> Total confirmed aircraft destroyed</li>
                                        <li><strong>Shots Bar:</strong> All weapons fired (missiles, guns, etc.)</li>
                                        <li><strong>Comparison:</strong> Shows engagement intensity vs. effectiveness</li>
                                        <li><strong>Colors:</strong> Green for kills, Blue for shots</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-info">Participation Metrics</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Active Pilots:</strong> Pilots who fired weapons or engaged</li>
                                        <li><strong>Active Groups:</strong> Formations that participated in combat</li>
                                        <li><strong>Scope:</strong> Indicates mission scale and complexity</li>
                                        <li><strong>Analysis:</strong> Higher numbers = larger, more complex engagement</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pilot Performance Section -->
        <div id="pilots-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h3><i class="fas fa-user-pilot me-2"></i>Pilot Performance Analysis</h3>
                </div>
                <div class="col-md-4 text-end">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="humanOnlyToggle">
                        <label class="form-check-label" for="humanOnlyToggle">
                            <i class="fas fa-filter me-1"></i>
                            <span id="toggleLabel">Show All Pilots</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Red Coalition Pilots -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="text-danger"><i class="fas fa-circle me-2"></i>Red Coalition</h4>
                </div>
            </div>
            <div class="row" id="redPilotCharts">
                {% for pilot_chart in session_data.visualizations.pilot_performance %}
                {% if pilot_chart.coalition == 'red' %}
                <div class="col-lg-6 mb-4 pilot-chart" data-is-human="{{ pilot_chart.is_player_controlled|lower }}">
                    <div class="chart-container">
                        <div id="pilotChart{{ loop.index }}"></div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            
            <!-- Blue Coalition Pilots -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="text-primary"><i class="fas fa-circle me-2"></i>Blue Coalition</h4>
                </div>
            </div>
            <div class="row" id="bluePilotCharts">
                {% for pilot_chart in session_data.visualizations.pilot_performance %}
                {% if pilot_chart.coalition == 'blue' %}
                <div class="col-lg-6 mb-4 pilot-chart" data-is-human="{{ pilot_chart.is_player_controlled|lower }}">
                    <div class="chart-container">
                        <div id="pilotChart{{ loop.index }}"></div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            
            <!-- Pilot Performance Legend -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Pilot Performance Metrics Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="text-primary">Radar Chart Metrics</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Accuracy:</strong> Hit percentage (hits/shots × 100)</li>
                                        <li><strong>K/D Ratio:</strong> Kills per death (scaled × 20, max 100)</li>
                                        <li><strong>Efficiency:</strong> Overall performance rating (0-100)</li>
                                        <li><strong>Activity:</strong> Combat engagement level (shots × 10)</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-success">Chart Interpretation</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Larger Area:</strong> Better overall performance</li>
                                        <li><strong>Balanced Shape:</strong> Well-rounded pilot skills</li>
                                        <li><strong>Spikes:</strong> Exceptional performance in specific areas</li>
                                        <li><strong>Scale:</strong> All metrics normalized to 0-100 range</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-warning">Coalition Organization</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Red Coalition:</strong> Displayed with red coloring</li>
                                        <li><strong>Blue Coalition:</strong> Displayed with blue coloring</li>
                                        <li><strong>Sorting:</strong> Pilots ordered by efficiency rating</li>
                                        <li><strong>Aircraft Type:</strong> Shown in chart title</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-info">Pilot Classification</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Human:</strong> Player-controlled pilots</li>
                                        <li><strong>AI:</strong> Computer-controlled pilots</li>
                                        <li><strong>Toggle Filter:</strong> Show/hide AI pilots</li>
                                        <li><strong>Identification:</strong> Marked in chart titles</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weapon Analysis Section -->
        <div id="weapons-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-crosshairs me-2"></i>Weapon Effectiveness Analysis</h3>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="weaponChart"></div>
            </div>
            
            <!-- Weapon Analysis Legend -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Comprehensive Weapon Analysis Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="text-primary">Effectiveness Matrix</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>X-Axis:</strong> Accuracy percentage (hits/shots)</li>
                                        <li><strong>Y-Axis:</strong> Effectiveness percentage (kills/shots)</li>
                                        <li><strong>Bubble Size:</strong> Total usage (shots fired)</li>
                                        <li><strong>Color Scale:</strong> Lethality percentage (kills/hits)</li>
                                        <li><strong>Top-Right:</strong> Most accurate and effective weapons</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-success">Coalition Preferences & Radar</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Red/Blue Bars:</strong> Coalition weapon usage comparison</li>
                                        <li><strong>Radar Chart:</strong> Top 5 weapons by usage</li>
                                        <li><strong>5 Metrics:</strong> Accuracy, effectiveness, lethality, usage, reliability</li>
                                        <li><strong>Larger Areas:</strong> Superior weapon performance</li>
                                        <li><strong>Color Coding:</strong> Different weapons distinguished</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-warning">Lethality vs Usage Analysis</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>X-Axis:</strong> Total shots fired</li>
                                        <li><strong>Y-Axis:</strong> Lethality percentage</li>
                                        <li><strong>Bubble Size:</strong> Overall effectiveness</li>
                                        <li><strong>Color Categories:</strong> Blue=Missiles, Red=Guns, Green=A2G</li>
                                        <li><strong>Top-Right:</strong> High-usage, high-lethality weapons</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-info">Pilot Mastery & Platform Analysis</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Heatmap:</strong> Pilot vs weapon mastery percentage</li>
                                        <li><strong>Color Scale:</strong> Red=High mastery, Blue=Low mastery</li>
                                        <li><strong>Sunburst Chart:</strong> Hierarchical weapon usage</li>
                                        <li><strong>Inner Ring:</strong> Weapon categories (Missiles, Guns, Other)</li>
                                        <li><strong>Outer Ring:</strong> Individual weapons with usage data</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Tactical Insights</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <strong>Weapon Categories:</strong> Missiles typically show higher lethality but lower usage. 
                                                Guns show higher usage but variable effectiveness based on pilot skill.
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Coalition Analysis:</strong> Compare weapon preferences between sides to identify 
                                                tactical doctrines and equipment advantages.
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Pilot Mastery:</strong> Identify weapon specialists and training opportunities. 
                                                Dark red areas indicate pilots with exceptional weapon proficiency.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Group Comparison Section -->
        <div id="groups-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-users me-2"></i>Formation Performance Analysis</h3>
                    <p class="text-muted">
                        Individual formation radar charts showing tactical effectiveness across multiple combat metrics.
                    </p>
                </div>
            </div>
            
            <!-- Red Coalition Groups -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="text-danger"><i class="fas fa-circle me-2"></i>Red Coalition Formations</h4>
                </div>
            </div>
            <div class="row" id="redGroupCharts">
                {% for group_chart in session_data.visualizations.group_comparison %}
                {% if group_chart.coalition == 'red' %}
                <div class="col-lg-6 mb-4 group-chart">
                    <div class="chart-container">
                        <div id="groupChart{{ loop.index }}"></div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            
            <!-- Blue Coalition Groups -->
            <div class="row mb-4">
                <div class="col-12">
                    <h4 class="text-primary"><i class="fas fa-circle me-2"></i>Blue Coalition Formations</h4>
                </div>
            </div>
            <div class="row" id="blueGroupCharts">
                {% for group_chart in session_data.visualizations.group_comparison %}
                {% if group_chart.coalition == 'blue' %}
                <div class="col-lg-6 mb-4 group-chart">
                    <div class="chart-container">
                        <div id="groupChart{{ loop.index }}"></div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            
            <!-- Group Performance Legend -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Formation Performance Metrics Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="text-primary">Radar Chart Metrics</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Accuracy:</strong> Formation average hit percentage</li>
                                        <li><strong>Survivability:</strong> Percentage of pilots who survived</li>
                                        <li><strong>Efficiency:</strong> Average pilot efficiency rating</li>
                                        <li><strong>Activity:</strong> Combat engagement level (shots × 5)</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-success">Chart Interpretation</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Larger Area:</strong> Better overall formation performance</li>
                                        <li><strong>Balanced Shape:</strong> Well-rounded tactical capabilities</li>
                                        <li><strong>Spikes:</strong> Exceptional performance in specific areas</li>
                                        <li><strong>Scale:</strong> All metrics normalized to 0-100 range</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-warning">Coalition Organization</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Red Formations:</strong> Displayed with red coloring</li>
                                        <li><strong>Blue Formations:</strong> Displayed with blue coloring</li>
                                        <li><strong>Sorting:</strong> Groups ordered by efficiency rating</li>
                                        <li><strong>Formation Size:</strong> Pilot count shown in title</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-info">Formation Details</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Title Format:</strong> Group Name (pilots, kills)</li>
                                        <li><strong>Coalition ID:</strong> Red/Blue formation identifier</li>
                                        <li><strong>Performance:</strong> Multi-metric tactical assessment</li>
                                        <li><strong>Comparison:</strong> Easy visual performance comparison</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline Section -->
        <div id="timeline-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-clock me-2"></i>Comprehensive Combat Timeline</h3>
                    <p class="text-muted">
                        Multi-track timeline showing the complete mission flow across different operational domains. 
                        Events are organized by type and coalition, with mission phases highlighted for tactical analysis.
                    </p>
                </div>
            </div>
            
            <div class="chart-container" style="min-height: 900px;">
                <div id="timelineChart"></div>
            </div>
            
            <!-- Timeline Legend and Controls -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Timeline Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="text-primary">Event Tracks</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>System:</strong> Mission start/end</li>
                                        <li><strong>Flight Ops:</strong> Engine startup, ejections</li>
                                        <li><strong>Combat Actions:</strong> First shots, engagements</li>
                                        <li><strong>Weapons:</strong> Weapon usage patterns</li>
                                        <li><strong>Results:</strong> Kills, deaths, casualties</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-success">Event Symbols</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>⭐:</strong> Mission events, kills</li>
                                        <li><strong>▲:</strong> First shots</li>
                                        <li><strong>◆:</strong> Ejections</li>
                                        <li><strong>■:</strong> Weapon fire</li>
                                        <li><strong>✕:</strong> Pilot deaths</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-warning">Mission Phases</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Pre-Combat:</strong> Setup and positioning</li>
                                        <li><strong>Active Combat:</strong> Engagement period</li>
                                        <li><strong>Post-Combat:</strong> Resolution phase</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-info">Coalition Colors</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><span class="badge bg-danger">Red</span> Coalition events</li>
                                        <li><span class="badge bg-primary">Blue</span> Coalition events</li>
                                        <li><span class="badge bg-success">Green</span> System events</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboard-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-trophy me-2"></i>Pilot Efficiency Rankings</h3>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="leaderboardChart"></div>
            </div>
            
            <!-- Leaderboard Legend -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Efficiency Rankings Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="text-primary">Efficiency Rating</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Scale:</strong> 0-100 composite performance score</li>
                                        <li><strong>Calculation:</strong> Weighted combination of multiple metrics</li>
                                        <li><strong>Factors:</strong> K/D ratio, accuracy, activity, survivability</li>
                                        <li><strong>Ranking:</strong> Higher scores = better performance</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-success">Star Rating System</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>★★★★★:</strong> 80+ (Elite performance)</li>
                                        <li><strong>★★★★☆:</strong> 60-79 (Excellent performance)</li>
                                        <li><strong>★★★☆☆:</strong> 40-59 (Good performance)</li>
                                        <li><strong>★★☆☆☆:</strong> 20-39 (Average performance)</li>
                                        <li><strong>★☆☆☆☆:</strong> 0-19 (Below average)</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-warning">Chart Features</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Horizontal Bars:</strong> Easy comparison of ratings</li>
                                        <li><strong>Coalition Colors:</strong> Red/Blue pilot identification</li>
                                        <li><strong>Top 10:</strong> Only highest performers shown</li>
                                        <li><strong>Text Labels:</strong> Rating and stars displayed</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-info">Performance Interpretation</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>High Efficiency:</strong> Skilled, effective pilot</li>
                                        <li><strong>Low Efficiency:</strong> Needs improvement or limited engagement</li>
                                        <li><strong>Coalition Balance:</strong> Compare red vs. blue performance</li>
                                        <li><strong>Pilot Development:</strong> Identify training needs</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Section -->
        <div id="network-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-project-diagram me-2"></i>Kill/Death Networks</h3>
                    <p class="text-muted">Comprehensive combat relationship analysis including pilot-to-pilot and pilot-to-ground engagements</p>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="networkChart"></div>
            </div>
            
            <!-- Network Legend -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Kill/Death Network Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="text-primary">Network Structure</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Pilots:</strong> Circular nodes in center area</li>
                                        <li><strong>Ground Units:</strong> Square nodes in outer ring</li>
                                        <li><strong>Red Lines:</strong> Pilot-to-pilot kills (solid)</li>
                                        <li><strong>Orange Lines:</strong> Ground unit kills (dotted)</li>
                                        <li><strong>Arrows:</strong> Point from killer to victim</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-success">Node Symbols</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Triangle Up:</strong> Pure killer (no deaths)</li>
                                        <li><strong>Diamond:</strong> Both killer and victim</li>
                                        <li><strong>X Symbol:</strong> Pure victim (no kills)</li>
                                        <li><strong>Circle:</strong> Observer (no direct involvement)</li>
                                        <li><strong>Size:</strong> Proportional to total kills</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-warning">Coalition Colors</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Red Pilots:</strong> Red circles/symbols</li>
                                        <li><strong>Blue Pilots:</strong> Blue circles/symbols</li>
                                        <li><strong>Red Ground:</strong> Dark red squares</li>
                                        <li><strong>Blue Ground:</strong> Dark blue squares</li>
                                        <li><strong>Hover Info:</strong> Detailed statistics on mouseover</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-info">Tactical Analysis</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Air Superiority:</strong> Pilot-to-pilot kill patterns</li>
                                        <li><strong>Ground Attack:</strong> CAS/SEAD effectiveness</li>
                                        <li><strong>Multi-Role:</strong> Pilots with both air and ground kills</li>
                                        <li><strong>Weapon Types:</strong> Shown in ground kill details</li>
                                        <li><strong>Timeline:</strong> Kill times available in hover data</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Air-to-Ground Analysis Section -->
        <div id="air-to-ground-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-bomb me-2"></i>Air-to-Ground Combat Analysis</h3>
                    <p class="text-muted">Comprehensive analysis of ground attack missions and surface target engagement</p>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="airToGroundChart"></div>
            </div>
            
            <!-- Air-to-Ground Legend -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Air-to-Ground Analysis Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="text-primary">A2G Shots vs Accuracy</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>X-Axis:</strong> Total air-to-ground shots fired</li>
                                        <li><strong>Y-Axis:</strong> Air-to-ground accuracy percentage</li>
                                        <li><strong>Colors:</strong> Red for Red Coalition, Blue for Blue Coalition</li>
                                        <li><strong>Analysis:</strong> Higher position = more accurate ground attack</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-success">Weapon Distribution</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Pie Chart:</strong> Air-to-ground weapon usage breakdown</li>
                                        <li><strong>Weapons:</strong> Bombs, missiles, rockets, etc.</li>
                                        <li><strong>Size:</strong> Proportional to usage frequency</li>
                                        <li><strong>Insight:</strong> Shows preferred ground attack weapons</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-warning">Coalition Performance</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Bars:</strong> A2G shots (lighter) and hits (darker)</li>
                                        <li><strong>Comparison:</strong> Red vs Blue coalition effectiveness</li>
                                        <li><strong>Colors:</strong> Red/dark red, Blue/dark blue</li>
                                        <li><strong>Assessment:</strong> Overall ground attack capability</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-info">Response Time</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Bars:</strong> Time to first air-to-ground shot</li>
                                        <li><strong>Unit:</strong> Time in seconds from mission start</li>
                                        <li><strong>Colors:</strong> Coalition-based coloring</li>
                                        <li><strong>Tactical:</strong> Shows ground attack initiation speed</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Air-to-Ground by Pilot Section -->
        <div id="ag-pilots-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-crosshairs me-2"></i>Air-to-Ground Performance by Pilot</h3>
                    <p class="text-muted">Individual pilot statistics for ground attack missions</p>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="agPilotChart"></div>
            </div>
            
            <!-- A2G Pilot Performance Legend -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Pilot A2G Performance Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary">Shots and Hits Chart</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Light Bars:</strong> Total air-to-ground shots fired</li>
                                        <li><strong>Dark Bars:</strong> Successful air-to-ground hits</li>
                                        <li><strong>Colors:</strong> Red for Red Coalition, Blue for Blue Coalition</li>
                                        <li><strong>Ranking:</strong> Pilots sorted by total A2G activity</li>
                                        <li><strong>Analysis:</strong> Compare volume vs. effectiveness</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success">Accuracy Chart</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Bars:</strong> Air-to-ground accuracy percentage</li>
                                        <li><strong>Scale:</strong> 0-100% accuracy rating</li>
                                        <li><strong>Colors:</strong> Coalition-based pilot identification</li>
                                        <li><strong>Selection:</strong> Top 15 most active A2G pilots</li>
                                        <li><strong>Evaluation:</strong> Precision in ground target engagement</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Air-to-Ground by Group Section -->
        <div id="ag-groups-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-users-cog me-2"></i>Air-to-Ground Performance by Group</h3>
                    <p class="text-muted">Formation-level statistics for ground attack effectiveness</p>
                </div>
            </div>
            
            <div class="chart-container">
                <div id="agGroupChart"></div>
            </div>
            
            <!-- A2G Group Performance Legend -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Group A2G Performance Guide</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="text-primary">A2G Shots by Group</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Bars:</strong> Total air-to-ground shots per formation</li>
                                        <li><strong>Colors:</strong> Red/Blue based on coalition</li>
                                        <li><strong>Metric:</strong> Group's total ground attack volume</li>
                                        <li><strong>Usage:</strong> Assess formation activity levels</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-success">A2G Accuracy by Group</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Bars:</strong> Formation air-to-ground accuracy</li>
                                        <li><strong>Scale:</strong> Percentage accuracy (0-100%)</li>
                                        <li><strong>Colors:</strong> Coalition-based identification</li>
                                        <li><strong>Analysis:</strong> Formation precision assessment</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-warning">A2G Hits by Group</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Bars:</strong> Successful air-to-ground hits per group</li>
                                        <li><strong>Metric:</strong> Actual ground target damage achieved</li>
                                        <li><strong>Colors:</strong> Coalition-based coloring</li>
                                        <li><strong>Effectiveness:</strong> Real impact measurement</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <h6 class="text-info">Group Efficiency</h6>
                                    <ul class="small text-muted mb-0">
                                        <li><strong>Scatter:</strong> A2G shots (X) vs accuracy (Y)</li>
                                        <li><strong>Size:</strong> Bubble size = total shots fired</li>
                                        <li><strong>Position:</strong> Right-upper = high volume + accurate</li>
                                        <li><strong>Comparison:</strong> Formation effectiveness matrix</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div id="summary-section" class="dashboard-section d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <h3><i class="fas fa-file-alt me-2"></i>Detailed Mission Summary</h3>
                </div>
            </div>
            
            <div class="row">
                <!-- Top Pilots -->
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-star me-2"></i>Top Performers</h5>
                        </div>
                        <div class="card-body">
                            {% set top_pilots = session_data.mission_data.pilots.items() | sort(attribute='1.efficiency_rating', reverse=true) | list %}
                            {% for pilot_name, pilot_data in top_pilots[:5] %}
                            {% set ground_kills = pilot_data.ground_units_killed | length %}
                            {% set total_kills = pilot_data.kills + ground_kills %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <strong>{{ pilot_name }}</strong>
                                    <small class="text-muted d-block">{{ pilot_data.aircraft_type }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-primary">{{ "%.1f"|format(pilot_data.efficiency_rating) }}</span>
                                    <small class="text-muted d-block">
                                        {{ total_kills }}K ({{ pilot_data.kills }}A+{{ ground_kills }}G) / {{ pilot_data.deaths }}D
                                    </small>
                                </div>
                            </div>
                            {% if not loop.last %}<hr class="my-2">{% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Mission Statistics -->
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Mission Statistics</h5>
                        </div>
                        <div class="card-body">
                            {% set total_shots = session_data.mission_data.pilots.values() | selectattr('shots_fired') | sum(attribute='shots_fired') %}
                            {% set total_hits = session_data.mission_data.pilots.values() | selectattr('hits_scored') | sum(attribute='hits_scored') %}
                            {% set total_air_kills = session_data.mission_data.pilots.values() | selectattr('kills') | sum(attribute='kills') %}
                            {% set total_ground_kills = session_data.mission_data.pilots.values() | map(attribute='ground_units_killed') | map('length') | sum %}
                            {% set total_kills = total_air_kills + total_ground_kills %}
                            {% set total_deaths = session_data.mission_data.pilots.values() | selectattr('deaths') | sum(attribute='deaths') %}
                            
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <h4 class="text-primary">{{ "%.1f"|format((total_hits / total_shots * 100) if total_shots > 0 else 0) }}%</h4>
                                    <small class="text-muted">Overall Accuracy</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <h4 class="text-success">{{ "%.2f"|format(total_kills / (total_deaths if total_deaths > 0 else 1)) }}</h4>
                                    <small class="text-muted">K/D Ratio ({{ total_air_kills }}A+{{ total_ground_kills }}G)</small>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-info">{{ session_data.mission_data.mission_summary.total_events }}</h4>
                                    <small class="text-muted">Total Events</small>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-warning">{{ session_data.mission_data.groups | length }}</h4>
                                    <small class="text-muted">Active Groups</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Pilot Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Detailed Pilot Statistics</h5>
                    <small class="text-muted">Click column headers to sort</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="pilotStatsTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="pilot" data-type="text">
                                        Pilot <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="aircraft" data-type="text">
                                        Aircraft <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="coalition" data-type="number">
                                        Coalition <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="type" data-type="text">
                                        Type <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="air_kills" data-type="number">
                                        Air Kills <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="ground_kills" data-type="number">
                                        Ground Kills <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="deaths" data-type="number">
                                        Deaths <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="kd" data-type="number">
                                        K/D <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="accuracy" data-type="number">
                                        Accuracy <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="efficiency" data-type="number">
                                        Efficiency <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pilot_name, pilot_data in session_data.mission_data.pilots.items() %}
                                {% set ground_kills = pilot_data.ground_units_killed | length %}
                                <tr>
                                    <td data-value="{{ pilot_name }}"><strong>{{ pilot_name }}</strong></td>
                                    <td data-value="{{ pilot_data.aircraft_type }}">{{ pilot_data.aircraft_type }}</td>
                                    <td data-value="{{ pilot_data.coalition }}">
                                        <span class="badge bg-{{ 'danger' if pilot_data.coalition == 1 else 'primary' }}">
                                            {{ 'Red' if pilot_data.coalition == 1 else 'Blue' }}
                                        </span>
                                    </td>
                                    <td data-value="{{ 'Human' if pilot_data.is_player_controlled else 'AI' }}">
                                        <span class="badge bg-{{ 'success' if pilot_data.is_player_controlled else 'secondary' }}">
                                            <i class="fas fa-{{ 'user' if pilot_data.is_player_controlled else 'robot' }} me-1"></i>
                                            {{ 'Human' if pilot_data.is_player_controlled else 'AI' }}
                                        </span>
                                    </td>
                                    <td data-value="{{ pilot_data.kills }}">
                                        {% if pilot_data.kills > 0 %}
                                            <span class="badge bg-danger">{{ pilot_data.kills }}</span>
                                        {% else %}
                                            <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ ground_kills }}">
                                        {% if ground_kills > 0 %}
                                            <span class="badge bg-warning text-dark">{{ ground_kills }}</span>
                                        {% else %}
                                            <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ pilot_data.deaths }}">{{ pilot_data.deaths }}</td>
                                    <td data-value="{{ pilot_data.kd_ratio }}">{{ "%.2f"|format(pilot_data.kd_ratio) }}</td>
                                    <td data-value="{{ pilot_data.accuracy }}">{{ "%.1f"|format(pilot_data.accuracy) }}%</td>
                                    <td data-value="{{ pilot_data.efficiency_rating }}">
                                        <span class="badge bg-{{ 'success' if pilot_data.efficiency_rating >= 60 else 'warning' if pilot_data.efficiency_rating >= 40 else 'secondary' }}">
                                            {{ "%.1f"|format(pilot_data.efficiency_rating) }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Table sorting functionality
    let currentSort = { column: null, direction: 'asc' };
    
    $('.sortable').click(function() {
        const column = $(this).data('column');
        const type = $(this).data('type');
        
        // Update sort direction
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.direction = 'asc';
        }
        currentSort.column = column;
        
        // Update sort icons
        $('.sort-icon').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
        $(this).find('.sort-icon')
            .removeClass('fa-sort')
            .addClass(currentSort.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
        
        // Sort the table
        sortTable(column, type, currentSort.direction);
    });
    
    function sortTable(column, type, direction) {
        const tbody = $('#pilotStatsTable tbody');
        const rows = tbody.find('tr').toArray();
        
        rows.sort(function(a, b) {
            let aVal, bVal;
            
            if (type === 'number') {
                aVal = parseFloat($(a).find(`td[data-value]`).eq(getColumnIndex(column)).data('value')) || 0;
                bVal = parseFloat($(b).find(`td[data-value]`).eq(getColumnIndex(column)).data('value')) || 0;
            } else {
                aVal = $(a).find(`td[data-value]`).eq(getColumnIndex(column)).data('value').toString().toLowerCase();
                bVal = $(b).find(`td[data-value]`).eq(getColumnIndex(column)).data('value').toString().toLowerCase();
            }
            
            if (direction === 'asc') {
                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            } else {
                return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
            }
        });
        
        tbody.empty().append(rows);
    }
    
    function getColumnIndex(column) {
        const columnMap = {
            'pilot': 0,
            'aircraft': 1,
            'coalition': 2,
            'type': 3,
            'air_kills': 4,
            'ground_kills': 5,
            'deaths': 6,
            'kd': 7,
            'accuracy': 8,
            'efficiency': 9
        };
        return columnMap[column] || 0;
    }

    // Navigation handling
    $('.sidebar-item').click(function() {
        $('.sidebar-item').removeClass('active');
        $(this).addClass('active');
        
        const target = $(this).data('target');
        $('.dashboard-section').addClass('d-none');
        $('#' + target + '-section').removeClass('d-none');
        
        // Trigger chart resize for better display
        setTimeout(function() {
            const chartElement = document.querySelector('#' + target + '-section .chart-container div');
            if (chartElement) {
                Plotly.Plots.resize(chartElement);
            }
        }, 100);
    });

    // Load and display charts
    const visualizations = {{ session_data.visualizations | tojson | safe }};
    
    // Mission Overview Chart
    if (visualizations.mission_overview) {
        const overviewData = JSON.parse(visualizations.mission_overview);
        Plotly.newPlot('missionOverviewChart', overviewData.data, overviewData.layout, {responsive: true});
    }

    // Pilot Performance Charts
    if (visualizations.pilot_performance) {
        visualizations.pilot_performance.forEach(function(pilotChart, index) {
            const chartData = JSON.parse(pilotChart.chart);
            Plotly.newPlot('pilotChart' + (index + 1), chartData.data, chartData.layout, {responsive: true});
        });
    }

    // Weapon Effectiveness Chart
    if (visualizations.weapon_effectiveness) {
        const weaponData = JSON.parse(visualizations.weapon_effectiveness);
        Plotly.newPlot('weaponChart', weaponData.data, weaponData.layout, {responsive: true});
    }

    // Group Comparison Charts (individual charts like pilot performance)
    if (visualizations.group_comparison) {
        visualizations.group_comparison.forEach(function(groupChart, index) {
            const chartData = JSON.parse(groupChart.chart);
            Plotly.newPlot('groupChart' + (index + 1), chartData.data, chartData.layout, {responsive: true});
        });
    }

    // Combat Timeline Chart
    if (visualizations.combat_timeline) {
        const timelineData = JSON.parse(visualizations.combat_timeline);
        Plotly.newPlot('timelineChart', timelineData.data, timelineData.layout, {responsive: true});
    }

    // Efficiency Leaderboard Chart
    if (visualizations.efficiency_leaderboard) {
        const leaderboardData = JSON.parse(visualizations.efficiency_leaderboard);
        Plotly.newPlot('leaderboardChart', leaderboardData.data, leaderboardData.layout, {responsive: true});
    }

    // Kill/Death Network Chart
    if (visualizations.kill_death_network) {
        const networkData = JSON.parse(visualizations.kill_death_network);
        Plotly.newPlot('networkChart', networkData.data, networkData.layout, {responsive: true});
    }

    // Air-to-Ground Analysis Chart
    if (visualizations.air_to_ground_analysis) {
        const agData = JSON.parse(visualizations.air_to_ground_analysis);
        Plotly.newPlot('airToGroundChart', agData.data, agData.layout, {responsive: true});
    }

    // Air-to-Ground Pilot Dashboard Chart
    if (visualizations.ag_pilot_dashboard) {
        const agPilotData = JSON.parse(visualizations.ag_pilot_dashboard);
        Plotly.newPlot('agPilotChart', agPilotData.data, agPilotData.layout, {responsive: true});
    }

    // Air-to-Ground Group Dashboard Chart
    if (visualizations.ag_group_dashboard) {
        const agGroupData = JSON.parse(visualizations.ag_group_dashboard);
        Plotly.newPlot('agGroupChart', agGroupData.data, agGroupData.layout, {responsive: true});
    }

    // Handle window resize
    $(window).resize(function() {
        $('.chart-container div').each(function() {
            if (this.id && !$(this).closest('.d-none').length) {
                Plotly.Plots.resize(this);
            }
        });
    });

    // Human-only toggle functionality
    $('#humanOnlyToggle').change(function() {
        const showHumanOnly = $(this).is(':checked');
        const toggleLabel = $('#toggleLabel');
        
        if (showHumanOnly) {
            toggleLabel.html('<i class="fas fa-user me-1"></i>Human Pilots Only');
            $('.pilot-chart').each(function() {
                const isHuman = $(this).data('is-human') === true || $(this).data('is-human') === 'true';
                if (!isHuman) {
                    $(this).hide();
                }
            });
        } else {
            toggleLabel.html('<i class="fas fa-users me-1"></i>Show All Pilots');
            $('.pilot-chart').show();
        }
    });

    // Initialize toggle label
    $('#toggleLabel').html('<i class="fas fa-users me-1"></i>Show All Pilots');
});

// Print functionality
function printReport() {
    window.print();
}

// Auto-refresh charts when section becomes visible
function refreshChartsInSection(sectionId) {
    setTimeout(function() {
        $('#' + sectionId + '-section .chart-container div').each(function() {
            if (this.id) {
                Plotly.Plots.resize(this);
            }
        });
    }, 200);
}
</script>

<style>
.sortable {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
}

.sortable:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.sort-icon {
    margin-left: 5px;
    opacity: 0.5;
    transition: opacity 0.2s ease;
}

.sortable:hover .sort-icon {
    opacity: 1;
}

.fa-sort-up, .fa-sort-down {
    opacity: 1 !important;
    color: #007bff;
}

@media print {
    .sidebar, .navbar {
        display: none !important;
    }
    
    .dashboard-section {
        display: block !important;
        page-break-after: always;
    }
    
    .chart-container {
        page-break-inside: avoid;
    }
}
</style>
{% endblock %} 